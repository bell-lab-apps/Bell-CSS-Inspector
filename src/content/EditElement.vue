<template>
  <div class="fixed right-0 m-6 top-0" style="width: 300px;">
    <Menu @close="closeExtension" :menu="menu" v-model="state.activeMenu"></Menu>
    <div class="bg-default p-5 rounded-lg overflow-x-hidden overflow-y-auto scroll" style="min-height: 200px; max-height: calc(100vh - 140px)">
      <transition :name="state.transition" mode="out-in">
        <component :key="state.activeMenu" :is="state.activeMenu" :activeElementId="state.activeElementId"></component>
      </transition>
    </div>
  </div>
</template>
<script>
import { onMounted, shallowReactive, watch } from 'vue';
import Properties from './components/EditElement/Properties.vue';
import Attributes from './components/EditElement/Attributes.vue';
import Codes from './components/EditElement/GlobalCss.vue';
import Palletes from './components/EditElement/WebsitePalettes.vue';
import Menu from './components/Menu.vue';
export default {
  components: { Properties, Menu, Attributes, Codes, Palletes },
  setup() {
    const state = shallowReactive({
      activeElementId: 0,
      activeMenu: 'properties',
      transition: 'slide-right',
    });
    const menu = [
      { name: 'properties', title: 'Element properties', icon: 'mdi-vector-square' },
      { name: 'attributes', title: 'Edit attributes', icon: 'mdi-square-edit-outline' },
      { name: 'codes', title: 'Global CSS Code', icon: 'mdi-code-tags' },
      { name: 'palletes', title: 'Website Palletes', icon: 'mdi-palette' },
    ];
    const eventHandler = target => {
      if (target.matches('.inspector,.active-element,html,body')) return;
      const activeElement = document.querySelector('.active-element');
      activeElement && activeElement.classList.remove('active-element');
      target.classList.add('active-element');
      state.activeElementId += 1;
    };
    const clickHandler = ({ target }) => eventHandler(target);
    const keyupHandler = ({ code, ctrlKey }) => {
      if (ctrlKey && code === 'Space') {
        const target = document.querySelector('.hover-element');
        eventHandler(target);
      }
    };
    const closeExtension = () => {
      window.removeEventListener('click', clickHandler);
      document.removeEventListener('keyup', keyupHandler);

      const container = document.querySelector('.inspector');
      document.body.removeChild(container);
      const activeElement = document.querySelector('.active-element');
      activeElement && activeElement.classList.remove('active-element');
    };
    onMounted(() => {
      window.addEventListener('click', clickHandler);
      document.addEventListener('keyup', keyupHandler);
    });
    watch(
      () => state.activeMenu,
      (value, old) => {
        const findIndex = key => menu.findIndex(({ name }) => key === name);
        const indexNewMenu = findIndex(value);
        const indexOldMenu = findIndex(old);
        state.transition = indexNewMenu > indexOldMenu ? 'slide-right' : 'slide-left';
      }
    );
    return {
      menu,
      state,
      closeExtension,
    };
  },
};
</script>
